pipeline {
    agent any

    stages {

        stage('runpy') {
            steps{
                sh '''
                python3 -m venv env
                . env/bin/activate
                pip install pytest
                pip install sqlalchemy
                pip install pyodbc
                pytest test_file_trial_delete.py
                '''
            }
        }
        stage('Deploy') {
            steps {
                sshagent(['jenkins-ssh-key']) {
                    withCredentials([string(credentialsId: 'github-pat', variable: 'PAT')]) {
                        sh '''
                            git fetch origin develop:develop
                            if git show-ref --quiet refs/heads/release; then
                                git clean -fd
                                git checkout release
                                git pull origin release
                            else
                                git checkout -b release
                            fi
                            git merge --no-ff develop
                            git remote set-url origin https://$PAT@github.com/OlenaEpam/finance_data.git
                            git push origin release
                        '''
                    }
                }
            }
        }
    }
}